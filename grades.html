<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta name="description" content="مدرسة تحفيظ ضمد الإبتدائية والمتوسطة – بوابتك الإلكترونية.">
<meta name="keywords" content="تحفيظ القرآن, مدرسة ضمد, تعليم جازان">
<meta name="author" content="مدرسة تحفيظ ضمد">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>الدرجات - مدرسة تحفيظ ضمد الإبتدائية والمتوسطة</title>

  <!-- الخط -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- CSS الموحد -->
  <link rel="stylesheet" href="css/style.css">

  <!-- PDF Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <style>
    /* تخصيصات خاصة بصفحة الدرجات فقط */
    .hint{ color:#555; margin-bottom:12px; }
    .form-row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:14px;
    }
    .status{
      margin-top:10px;
      font-weight:700;
    }
    #pdfContainer canvas{
      width:100%;
      height:auto;
      border-radius:12px;
      margin-top:12px;
      border:1px solid #e0e0e0;
    }
    .download-btn{
      margin-top:14px;
      background:#1e88e5;
    }
  </style>
</head>

<body>
<div class="image-header">
  <div class="image-header-inner">
  <center>
    <img src="images/ban5ner.jpeg" width=200 height=200 align=center alt="أنشطة المدرسة">
  </div>
</div>
</div>
<!-- ===== BANNER ===== -->

<!-- ===== NAVBAR ===== -->
<nav class="navbar">
  <ul>
    <li><a class="active" href="grades.html">النتائج</a></li>
    
  </ul>
</nav>

<!-- ===== CONTENT ===== -->
<div class="wrap">
  <div class="card">

    <h2>الاستعلام عن إشعار الدرجات</h2>
    <center>
<br>
<font color="white"
    <div class="form-row">
      <input type="text" id="studentId" placeholder="أدخل رقم الهوية الوطنية">
      <button onclick="searchCertificate()">
        <i class="fa fa-search"></i> بحث
      </button>
    </div>

    <div id="result" class="status"></div>
    <div id="pdfContainer"></div>

    <button id="downloadBtn" class="download-btn" style="display:none;">
      تحميل الشهادة PDF
    </button>

  </div>
</div>

<!-- ===== FOOTER ===== -->

<footer>	
  جميع الحقوق محفوظة © 2024<br>
  مدرسة تحفيظ ضمد الإبتدائية والمتوسطة
</footer>

<!-- ===== WHATSAPP FLOAT ===== -->
<a class="whatsapp-float"
   href="https://wa.me/966548884252"
   target="_blank"
   aria-label="تواصل عبر واتساب">
  <i class="fab fa-whatsapp"></i>
</a>

<!-- ===== SCRIPT ===== -->
<script>
let foundPage = null;
let pdfDoc = null;

async function searchCertificate() {
  const studentId = document.getElementById('studentId').value.trim();
  const resultDiv = document.getElementById('result');
  const pdfContainer = document.getElementById('pdfContainer');
  const downloadBtn = document.getElementById('downloadBtn');

  pdfContainer.innerHTML = "";
  resultDiv.textContent = "";
  downloadBtn.style.display = "none";

  if (studentId.length !== 10 || isNaN(studentId)) {
    resultDiv.textContent = "❌ رقم الهوية غير صحيح. يجب أن يتكون من 10 أرقام.";
    return;
  }

  resultDiv.textContent = "⏳ جاري البحث...";

  const pdfFiles = [
    'uploads/3.pdf','uploads/4.pdf','uploads/5.pdf',
    'uploads/6.pdf','uploads/7.pdf','uploads/8.pdf','uploads/9.pdf'
  ];

  let certificateFound = false;

  for (const pdfFile of pdfFiles) {
    try {
      pdfDoc = await pdfjsLib.getDocument(pdfFile).promise;

      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const page = await pdfDoc.getPage(pageNum);
        const textContent = await page.getTextContent();
        const text = textContent.items.map(item => item.str).join(" ");

        if (text.includes(studentId)) {
          displayCertificatePage(page, pdfContainer);
          foundPage = pageNum;
          downloadBtn.style.display = "inline-block";
          certificateFound = true;
          break;
        }
      }
    } catch (e) {
      console.error("PDF load error:", e);
    }

    if (certificateFound) break;
  }

  resultDiv.textContent = certificateFound
    ? "✅ تم العثور على الشهادة."
    : "❌ لم يتم العثور على شهادة لهذا الرقم.";
}

function displayCertificatePage(page, container) {
  const viewport = page.getViewport({ scale: 1.5 });
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');

  canvas.height = viewport.height;
  canvas.width = viewport.width;

  page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
    container.appendChild(canvas);
  });
}

async function downloadCertificate() {
  if (foundPage && pdfDoc) {
    const pdfBytes = await pdfDoc.getData();
    const pdfDocNew = await PDFLib.PDFDocument.load(new Uint8Array(pdfBytes));
    const newPdf = await PDFLib.PDFDocument.create();
    const [copiedPage] = await newPdf.copyPages(pdfDocNew, [foundPage - 1]);
    newPdf.addPage(copiedPage);

    const blob = new Blob([await newPdf.save()], { type: 'application/pdf' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `الشهادة_${foundPage}.pdf`;
    link.click();
  }
}

document.getElementById('downloadBtn').addEventListener('click', downloadCertificate);
</script>

</body>
</html>
